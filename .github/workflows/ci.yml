---
name: CI

on: [push, pull_request]

# When this issue [ https://github.com/actions/cache/issues/698 ] will be fixed you should:
#  1. Uncomment `dependencies` part as is.
#  2. Inside `static-code-analysis` and `tests` parts you should:
#    a. Uncomment 'needs'.
#    b. Uncomment steps with name 'Retrieve cached dependencies'.
#    c. Remove steps with the name 'Install dependencies' because they will be retrieved from cache.

jobs:
  # dependencies:
  #   runs-on: ubuntu-latest

  #   strategy:
  #     matrix:
  #       elixir: ['1.13']
  #       otp: ['24']

  #   steps:
  #     - name: Cancel previous runs
  #       uses: styfle/cancel-workflow-action@0.9.0
  #       with:
  #         access_token: ${{ github.token }}

  #     - name: Checkout Github repo
  #       uses: actions/checkout@v2

  #     - name: Sets up an Erlang/OTP environment
  #       uses: erlef/setup-beam@v1
  #       with:
  #         elixir-version: ${{ matrix.elixir }}
  #         otp-version: ${{ matrix.otp }}

  #     - name: Retrieve cached dependencies
  #       uses: actions/cache@v2
  #       id: mix-cache
  #       with:
  #         path: |
  #           deps
  #           _build
  #           priv/plts
  #         key: ${{ runner.os }}-${{ matrix.otp }}-${{ matrix.elixir }}-${{ hashFiles('**/mix.lock') }}

  #     - name: Install dependencies
  #       if: steps.mix-cache.outputs.cache-hit != 'true'
  #       run: |
  #         mkdir -p priv/plts
  #         mix local.rebar --force
  #         mix local.hex --force
  #         mix deps.get
  #         mix deps.compile
  #         mix compile
  #         mix dialyzer --plt

  static-code-analysis:
    # needs: dependencies

    runs-on: ubuntu-latest

    strategy:
      matrix:
        elixir: ['1.13']
        otp: ['24']

    steps:
      - name: Cancel previous runs
        uses: styfle/cancel-workflow-action@0.9.0
        with:
          access_token: ${{ github.token }}

      - name: Checkout Github repo
        uses: actions/checkout@v2

      - name: Sets up an Erlang/OTP environment
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}

      # - name: Retrieve cached dependencies
      #   uses: actions/cache@v2
      #   id: mix-cache
      #   with:
      #     path: |
      #       deps
      #       _build
      #       priv/plts
      #     key: ${{ runner.os }}-${{ matrix.otp }}-${{ matrix.elixir }}-${{ hashFiles('**/mix.lock') }}

      - name: Install dependencies
        run: |
          mkdir -p priv/plts
          mix local.rebar --force
          mix local.hex --force
          mix deps.get
          mix deps.compile
          mix compile
          mix dialyzer --plt

      - name: Check Code Format
        run: mix format --check-formatted

      - name: Run Credo
        run: mix credo --strict

      - name: Run Dialyzer
        run: mix dialyzer --no-check --ignore-exit-status

  tests:
    # needs: dependencies

    runs-on: ubuntu-latest

    strategy:
      matrix:
        elixir: ['1.13']
        otp: ['24']

    steps:
      - name: Cancel previous runs
        uses: styfle/cancel-workflow-action@0.9.0
        with:
          access_token: ${{ github.token }}

      - name: Checkout Github repo
        uses: actions/checkout@v2

      - name: Sets up an Erlang/OTP environment
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}

      # - name: Retrieve cached dependencies
      #   uses: actions/cache@v2
      #   id: mix-cache
      #   with:
      #     path: |
      #       deps
      #       _build
      #       priv/plts
      #     key: ${{ runner.os }}-${{ matrix.otp }}-${{ matrix.elixir }}-${{ hashFiles('**/mix.lock') }}

      - name: Install dependencies
        run: |
          mkdir -p priv/plts
          mix local.rebar --force
          mix local.hex --force
          mix deps.get
          mix deps.compile
          mix compile
          mix dialyzer --plt

      - run: mix test --trace --slowest 10
